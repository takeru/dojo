# トピック: 浮動小数点数の注意点

## メタ情報

- **ID**: float-pitfalls
- **難易度**: 初級
- **所要時間**: 8-10分（対話形式）/ 4-5分（読み物）
- **カテゴリ**: 変数・型

## 前提知識

- Stage 3完了（変数と型）
- 浮動小数点数の基本

## このトピックで学べること

- 浮動小数点数の誤差問題
- なぜ誤差が発生するのか
- 誤差への対処方法

## 関連ステージ

- Stage 3: 変数と型（ここで登場）

## 要点（ドキュメント形式用）

### 浮動小数点数には誤差がある

浮動小数点数（f32, f64）には必ず誤差があります。これはコンピュータの仕組みから来る避けられない問題です。

```rust
let x = 0.1 + 0.2;
println!("{}", x);  // 0.30000000000000004 になることがある
```

### なぜ誤差が発生するのか

コンピュータは2進数で計算しますが、0.1 や 0.2 などの10進数は2進数で正確に表現できません。

例えば、1/3 を十進数で書くと 0.333333... と無限に続くように、0.1 を二進数で書くと無限に続きます。

### これはRustだけの問題ではない

JavaScript, Python, Java, C++など、すべての言語で共通の問題です。

```python
# Python
print(0.1 + 0.2)  # 0.30000000000000004
```

```javascript
// JavaScript
console.log(0.1 + 0.2);  // 0.30000000000000004
```

### 対策1: 許容誤差を設定

等号比較ではなく、差の絶対値が小さいかチェック：

```rust
let x = 0.1 + 0.2;
let expected = 0.3;

// ❌ 避けるべき
if x == expected {
    println!("等しい");
}

// ✅ 推奨
if (x - expected).abs() < 0.0001 {
    println!("ほぼ等しい");
}
```

### 対策2: 固定小数点数を使う

金銭計算など、正確な計算が必要な場合は `rust_decimal` などのライブラリを使います：

```rust
// Cargo.toml に追加: rust_decimal = "1.0"
use rust_decimal::Decimal;

let price = Decimal::new(100, 0);  // 100円
let tax = Decimal::new(8, 0);      // 8%
```

### 対策3: 整数に変換して計算

```rust
// 金額を「銭」単位で扱う
let price_cents = 123;  // 1.23円 → 123銭
let tax_cents = (price_cents * 8) / 100;  // 8%の税金
```

### f32 vs f64

| 型 | 精度 | 使いどころ |
|----|------|-----------|
| f32 | 約7桁 | メモリ節約が必要な場合 |
| f64 | 約15桁 | 通常はこれ（デフォルト） |

## 対話形式の教え方ガイド（先生用）

### 導入

「浮動小数点数には、知っておくべき重要な罠があるのじゃ」

なぜこれを知っておくと重要か：
- バグの原因になる
- 金銭計算で問題が起きる
- すべてのプログラマーが知るべき基礎知識

### 説明の流れ

1. **誤差を実際に確認**
   ```rust
   fn main() {
       let x = 0.1 + 0.2;
       println!("{}", x);
   }
   ```
   「実行してみるのじゃ。何が表示される？」

2. **原因を説明**
   「これはRustの問題ではないのじゃ。コンピュータが2進数で計算するから、10進数の0.1を正確に表現できんのじゃ」

3. **等号比較の危険性を示す**
   ```rust
   let x = 0.1 + 0.2;
   if x == 0.3 {
       println!("等しい");
   } else {
       println!("等しくない");  // こちらが表示される
   }
   ```

4. **正しい比較方法**
   ```rust
   let x = 0.1 + 0.2;
   if (x - 0.3).abs() < 0.0001 {
       println!("ほぼ等しい");
   }
   ```

5. **実用的な対策**
   「お金の計算では、整数（銭単位）や専用ライブラリを使うのじゃ」

### 実践課題（オプション）

1. 0.1 + 0.2 の結果を確認
2. 等号比較と許容誤差比較の違いを確認
3. 整数に変換して計算する方法を試す

## クリア条件（オプション）

理解度チェック：
- [ ] 浮動小数点数に誤差があることを理解している
- [ ] 等号比較を避けるべき理由を説明できる
- [ ] 許容誤差を使った比較ができる

## 補足情報

### NaN (Not a Number)

不正な演算の結果：

```rust
let x = 0.0 / 0.0;  // NaN
println!("{}", x.is_nan());  // true
```

NaN は自分自身とも等しくないという特殊な性質があります：

```rust
let x = 0.0 / 0.0;
println!("{}", x == x);  // false !
```

### 無限大

```rust
let inf = 1.0 / 0.0;  // inf（無限大）
let neg_inf = -1.0 / 0.0;  // -inf（負の無限大）
```

### IEEE 754

Rustの浮動小数点数は IEEE 754 という国際標準に従っています。この標準のため、すべての言語で同じ挙動になります。

### 参考リンク

- The Rust Book: https://doc.rust-lang.org/book/ch03-02-data-types.html#floating-point-types
- 浮動小数点数ガイド: https://floating-point-gui.de/
- IEEE 754: https://en.wikipedia.org/wiki/IEEE_754
