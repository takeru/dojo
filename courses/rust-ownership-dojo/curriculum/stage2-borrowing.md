# Stage 2: 借用（Borrowing）

## 目標

このステージを完了すると、生徒は：
- 参照と借用の概念を理解できる
- 不変参照と可変参照の違いを理解できる
- 借用ルールを説明できる
- 参照を使った関数を書ける

## 前提知識

- Stage 1完了（所有権の理解）
- ムーブセマンティクスの理解

## 関連する発展トピック（サブクエスト）

このステージをクリアした後、以下のトピックで深く学べます：
- **borrow-checker** - 借用チェッカーの仕組み

## 教え方ガイド

### 導入（なぜこれを学ぶか）

所有権システムでは値がムーブされると元の変数が使えなくなります。しかし実際には、値を「一時的に借りる」だけで十分な場合が多くあります。借用（borrowing）はこの問題を解決する仕組みです。

### 説明の流れ

1. **参照の基本**
   ```rust
   let s1 = String::from("hello");
   let len = calculate_length(&s1);  // &で参照を作る
   println!("'{}' の長さは {} です", s1, len);  // s1はまだ使える

   fn calculate_length(s: &String) -> usize {
       s.len()
   }
   ```

2. **借用のルール**
   - いつでも、複数の不変参照 または 1つの可変参照のどちらか
   - 参照は常に有効でなければならない

3. **可変参照**
   ```rust
   let mut s = String::from("hello");
   change(&mut s);

   fn change(s: &mut String) {
       s.push_str(", world");
   }
   ```

4. **複数の借用の制限**
   ```rust
   let mut s = String::from("hello");
   let r1 = &s;     // OK
   let r2 = &s;     // OK
   // let r3 = &mut s; // エラー！不変参照が存在する間は可変参照不可
   ```

### よくある間違い

- 可変参照と不変参照を同時に作ろうとする → 借用ルールの説明
- 参照のスコープを理解していない → 非レキシカルライフタイムの説明
- &と&mutの使い分けが曖昧 → 読み取りのみか変更するかで判断

## 演習課題

### 課題1: 不変参照の使用
関数に値の参照を渡して、元の変数を保持したまま処理を行ってください。

### 課題2: 可変参照の使用
関数で値を変更する際に、可変参照を使ってください。

### 課題3: 借用ルールの確認
複数の不変参照と可変参照を同時に使おうとして、コンパイルエラーを確認してください。

## 評価基準

以下がすべて満たされたらステージクリア：

- [ ] 参照の作り方（&と&mut）を理解している
- [ ] 借用の2つのルールを説明できる
- [ ] 参照を使った関数を書ける
- [ ] 借用エラーを読み解いて修正できる

## ヒント集

### ヒント1（軽め）
参照は値を「借りる」だけで、所有権は元の変数に残ります。

### ヒント2（中程度）
`&`で不変参照、`&mut`で可変参照を作ります。可変参照は同時に1つだけしか作れません。

### ヒント3（具体的）
```rust
fn main() {
    let mut s = String::from("hello");

    // 不変参照は複数OK
    let r1 = &s;
    let r2 = &s;
    println!("{} and {}", r1, r2);
    // r1とr2はここまでで使われなくなる

    // 可変参照を作る（不変参照が使われなくなった後）
    let r3 = &mut s;
    r3.push_str(", world");
    println!("{}", r3);
}
```

## 補足・発展トピック

### トピック1: なぜ借用ルールがあるのか？

**質問**: なぜ可変参照は1つだけなの？

**説明**:
可変参照を同時に複数持てると、データ競合が発生する可能性があります。Rustの借用ルールは、コンパイル時にデータ競合を防ぐための仕組みです。

複数の不変参照はOK（読み取りのみなら安全）
可変参照は1つだけ（書き込み中は他の参照不可）

### トピック2: スコープと借用

**質問**: 参照のスコープはどう決まるの？

**説明**:
Rustは「非レキシカルライフタイム」(NLL)を使用しており、参照は最後に使われた場所までが有効範囲です。

```rust
let mut s = String::from("hello");

let r1 = &s;
let r2 = &s;
println!("{} and {}", r1, r2);
// r1とr2はここで終わり（最後の使用）

let r3 = &mut s;  // OK！r1とr2はもう使われていない
println!("{}", r3);
```

### 参考リンク

- The Rust Book: https://doc.rust-lang.org/book/ch04-02-references-and-borrowing.html
- Rust By Example: https://doc.rust-lang.org/rust-by-example/scope/borrow.html
