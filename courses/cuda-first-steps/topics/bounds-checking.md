# トピック: `if (idx < n)` は何のため？

## メタ情報

- **ID**: bounds-checking
- **難易度**: 初級
- **所要時間**: 3-5分（対話形式）/ 1-2分（読み物）
- **カテゴリ**: エラー防止

## 前提知識

- Stage 2完了

## このトピックで学べること

- 配列外アクセスを防ぐ境界チェック
- スレッド数と配列サイズの関係
- カーネル内での安全なプログラミング

## 関連ステージ

- Stage 2: CPUとGPUで同じことをやってみる

## 要点（ドキュメント形式用）

カーネル起動時に、実際の配列サイズよりも多くのスレッドを起動してしまう場合があります。

### 問題の例

配列サイズが10なのに、`<<<1, 16>>>`（16スレッド）で起動すると：

```cuda
int idx = threadIdx.x;  // idx = 0, 1, 2, ..., 15
arr[idx] = arr[idx] * 2;  // idx >= 10 で配列外アクセス！
```

### 解決策

```cuda
int idx = threadIdx.x;
if (idx < 10) {  // idx >= 10 のスレッドは何もしない
    arr[idx] = arr[idx] * 2;
}
```

### なぜ起きるか

- ブロックサイズは32の倍数が推奨（Warp効率）
- 配列サイズはぴったり割り切れないことが多い
- 余分なスレッドは `if` で弾く必要がある

## 対話形式の教え方ガイド（先生用）

### 導入

「なぜ毎回 `if (idx < n)` を書くの？」

### 説明の流れ

1. **問題を説明**
   - 配列サイズ10に対して16スレッド起動
   - スレッド10〜15が配列外にアクセス

2. **境界チェックの重要性**
   - クラッシュやゴミデータの原因

3. **パターンとして覚える**
   ```cuda
   if (idx < n) {
       // 安全な処理
   }
   ```

## クリア条件（オプション）

- [ ] 境界チェックが必要な理由を説明できる
- [ ] 自分でチェックを書ける

## 補足情報

### 参考リンク

- [CUDA C++ Programming Guide - Thread Hierarchy](https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#thread-hierarchy)
